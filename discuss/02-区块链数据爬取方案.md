# 区块链数据爬取和动态 Tab 功能实现方案

## 1. 需求分析

### 核心需求
1. 从 Sepolia 网络爬取 ERC-8004 ID Registry 的 NFT 数据
2. 定时更新数据（后台任务）
3. 替换首页的静态数据为动态数据
4. 实现 Tab 页功能，展示不同数据视图

### 参考功能
- Overview：整体统计和精选代理
- Agents：所有代理列表（支持筛选、搜索、分页）
- Networks：网络信息
- Recent Activity：最近活动记录

## 2. 技术方案

### 2.1 区块链数据爬取

#### ERC-8004 ID Registry 合约
```
合约地址: 需要从官方获取 Sepolia 测试网地址
事件监听:
- AgentRegistered(uint256 tokenId, address owner, string metadataURI)
- AgentUpdated(uint256 tokenId, string metadataURI)
- Transfer(address from, address to, uint256 tokenId)
```

#### 技术栈
- **Web3.py**: Python Web3 库
- **APScheduler**: 定时任务调度
- **HTTPX**: 异步 HTTP 请求
- **Sepolia RPC**: Infura/Alchemy 节点

#### 爬取策略
1. **增量爬取**: 记录最后处理的区块高度
2. **批量获取**: 每次获取 1000 个区块的事件
3. **元数据解析**: 从 IPFS/HTTP 获取代理元数据
4. **错误重试**: 失败重试机制（最多 3 次）

### 2.2 数据模型扩展

#### Agent 模型增强
```python
- token_id: int (链上 NFT ID)
- owner_address: str (所有者地址)
- metadata_uri: str (元数据 URI)
- on_chain_data: JSON (链上原始数据)
- last_synced_at: datetime (最后同步时间)
- sync_status: enum (syncing, synced, failed)
```

#### BlockchainSync 模型（新增）
```python
- id: UUID
- network_id: str
- contract_address: str
- last_block: int (最后处理的区块)
- last_synced_at: datetime
- status: enum (running, idle, error)
```

### 2.3 Tab 页功能

#### Tab 分类
1. **All Agents**: 所有代理
2. **Active**: 活跃代理（最近 7 天有活动）
3. **New**: 新注册代理（最近 24 小时）
4. **Top Rated**: 按信誉评分排序
5. **My Agents**: 用户拥有的代理（需要连接钱包）

#### 前端组件
```typescript
<Tabs defaultValue="all">
  <TabsList>
    <TabsTrigger value="all">All Agents</TabsTrigger>
    <TabsTrigger value="active">Active</TabsTrigger>
    <TabsTrigger value="new">New</TabsTrigger>
    <TabsTrigger value="top">Top Rated</TabsTrigger>
  </TabsList>
  <TabsContent value="all">
    <AgentGrid agents={allAgents} />
  </TabsContent>
  ...
</Tabs>
```

## 3. 实现步骤

### Phase 1: 后端爬虫服务
1. 安装 Web3.py 依赖
2. 创建区块链同步服务
3. 实现事件监听和数据解析
4. 添加定时任务（每 5 分钟）
5. 实现错误处理和日志

### Phase 2: 数据库升级
1. 更新 Agent 模型
2. 创建 BlockchainSync 模型
3. 迁移脚本
4. 测试数据同步

### Phase 3: API 增强
1. 添加 Tab 筛选参数
2. 优化查询性能（索引）
3. 添加缓存层（可选）
4. 实时数据 API

### Phase 4: 前端 Tab 实现
1. 创建 Tabs 组件
2. 实现状态管理
3. 对接动态 API
4. 添加加载状态和错误处理

### Phase 5: 测试和优化
1. 端到端测试
2. 性能优化
3. 错误监控
4. 文档完善

## 4. 技术细节

### 4.1 Web3 连接
```python
from web3 import Web3

# Sepolia RPC
RPC_URL = "https://sepolia.infura.io/v3/YOUR_PROJECT_ID"
w3 = Web3(Web3.HTTPProvider(RPC_URL))

# 合约 ABI
registry_abi = [...]  # ERC-8004 ID Registry ABI
registry_address = "0x..."  # 合约地址

contract = w3.eth.contract(address=registry_address, abi=registry_abi)
```

### 4.2 事件监听
```python
# 获取历史事件
events = contract.events.AgentRegistered.get_logs(
    fromBlock=last_block,
    toBlock=current_block
)

for event in events:
    token_id = event['args']['tokenId']
    owner = event['args']['owner']
    metadata_uri = event['args']['metadataURI']
    # 处理事件...
```

### 4.3 元数据获取
```python
async def fetch_metadata(uri: str) -> dict:
    if uri.startswith('ipfs://'):
        # 从 IPFS 网关获取
        url = f"https://ipfs.io/ipfs/{uri[7:]}"
    else:
        url = uri

    async with httpx.AsyncClient() as client:
        response = await client.get(url, timeout=10)
        return response.json()
```

### 4.4 定时任务
```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('interval', minutes=5)
async def sync_blockchain_data():
    await blockchain_sync_service.sync()

scheduler.start()
```

## 5. API 接口设计

### 获取代理列表（支持 Tab 筛选）
```
GET /api/agents?tab=all&page=1&page_size=20

Parameters:
- tab: all | active | new | top
- page: 页码
- page_size: 每页数量
- search: 搜索关键词
- network: 网络筛选

Response:
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "total_pages": 5
}
```

### 获取同步状态
```
GET /api/sync/status

Response:
{
  "network": "sepolia",
  "last_block": 5123456,
  "current_block": 5123500,
  "last_synced_at": "2024-11-04T12:00:00Z",
  "status": "synced"
}
```

## 6. 前端 Tab 状态管理

```typescript
// useAgents.ts
export function useAgents(tab: TabType) {
  const [agents, setAgents] = useState<Agent[]>([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    async function fetchAgents() {
      setLoading(true);
      try {
        const data = await agentService.getAgents({ tab });
        setAgents(data.items);
      } finally {
        setLoading(false);
      }
    }
    fetchAgents();
  }, [tab]);

  return { agents, loading };
}
```

## 7. 性能优化

### 数据库索引
```sql
CREATE INDEX idx_agents_status ON agents(status);
CREATE INDEX idx_agents_created_at ON agents(created_at DESC);
CREATE INDEX idx_agents_reputation ON agents(reputation_score DESC);
CREATE INDEX idx_agents_token_id ON agents(token_id);
```

### 缓存策略
- Redis 缓存热点数据（5 分钟过期）
- 首页统计数据缓存（1 分钟过期）
- Featured Agents 缓存（5 分钟过期）

## 8. 监控和日志

### 关键指标
- 同步延迟（当前区块 - 最后同步区块）
- 同步失败次数
- API 响应时间
- 数据库查询性能

### 日志记录
```python
logger.info(f"Synced block {block_number}")
logger.error(f"Failed to fetch metadata: {error}")
logger.warning(f"Sync lag detected: {lag} blocks")
```

## 9. 下一步行动

1. ✅ 完成方案设计
2. 安装 Web3.py 依赖
3. 实现区块链同步服务
4. 更新数据库模型
5. 实现定时任务
6. 创建 Tab 组件
7. 对接动态数据
8. 测试和优化
