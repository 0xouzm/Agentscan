#!/bin/bash

# Docker ç¯å¢ƒä¸‹å®Œæ•´é‡ç½®æ•°æ®åº“
# âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼

set -e

echo "âš ï¸  æ•°æ®åº“å®Œæ•´é‡ç½®"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "æ­¤æ“ä½œå°†ï¼š"
echo "  - åœæ­¢æ‰€æœ‰æœåŠ¡"
echo "  - åˆ é™¤æ•°æ®åº“æ–‡ä»¶"
echo "  - é‡æ–°åˆ›å»ºæ•°æ®åº“"
echo "  - é‡æ–°åˆå§‹åŒ–ç½‘ç»œ"
echo ""
read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ(yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "âŒ æ“ä½œå·²å–æ¶ˆ"
    exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ æ­¥éª¤ 1/6: å¤‡ä»½ç°æœ‰æ•°æ®åº“"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f data/8004scan.db ]; then
    mkdir -p backups
    backup_file="backups/8004scan.db.backup.$(date +%Y%m%d_%H%M%S)"
    cp data/8004scan.db "$backup_file"
    echo "âœ… æ•°æ®åº“å·²å¤‡ä»½åˆ°: $backup_file"
    echo "   å¤§å°: $(du -h $backup_file | cut -f1)"
else
    echo "âš ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ›‘ æ­¥éª¤ 2/6: åœæ­¢æœåŠ¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker compose down
echo "âœ… æ‰€æœ‰å®¹å™¨å·²åœæ­¢"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ—‘ï¸  æ­¥éª¤ 3/6: åˆ é™¤æ•°æ®åº“"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f data/8004scan.db ]; then
    rm -f data/8004scan.db
    echo "âœ… æ•°æ®åº“æ–‡ä»¶å·²åˆ é™¤"
else
    echo "â„¹ï¸  æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ æ­¥éª¤ 4/6: å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker compose up -d
echo "âœ… æœåŠ¡å·²å¯åŠ¨"

echo ""
echo "â³ ç­‰å¾…å®¹å™¨å®Œå…¨å¯åŠ¨..."
sleep 15

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… æ­¥éª¤ 5/6: éªŒè¯æ•°æ®åº“"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker compose exec backend uv run python -c "
import sqlite3
from src.db.database import SessionLocal
from src.models import Network

# æ£€æŸ¥è¡¨
conn = sqlite3.connect('/app/data/8004scan.db')
cursor = conn.cursor()
cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\")
tables = [t[0] for t in cursor.fetchall()]
conn.close()

print('ğŸ“‹ æ•°æ®åº“è¡¨:')
for table in tables:
    print(f'  âœ“ {table}')

# æ£€æŸ¥ç½‘ç»œ
db = SessionLocal()
networks = db.query(Network).all()
print('\nğŸ“‹ ç½‘ç»œåˆ—è¡¨:')
for n in networks:
    contracts = 'âœ“' if n.contracts else 'âœ—'
    print(f'  ID: {n.id:20s} | Name: {n.name:25s} | Contracts: {contracts}')
db.close()
"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š æ­¥éª¤ 6/6: åŒæ­¥é€‰é¡¹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "æ•°æ®åº“é‡ç½®å®Œæˆï¼ç°åœ¨å¯ä»¥ï¼š"
echo ""
echo "é€‰é¡¹ 1 - ç­‰å¾…è‡ªåŠ¨åŒæ­¥ï¼ˆæ¨èï¼‰ï¼š"
echo "  å®šæ—¶ä»»åŠ¡ä¼šåœ¨æ¯10åˆ†é’Ÿçš„å›ºå®šæ—¶é—´è‡ªåŠ¨è§¦å‘"
echo "  ä¸‹ä¸€æ¬¡åŒæ­¥æ—¶é—´ï¼š$(date -d '+10 minutes' '+%H:%M' 2>/dev/null || date -v+10M '+%H:%M')"
echo ""
echo "é€‰é¡¹ 2 - ç«‹å³æ‰‹åŠ¨è§¦å‘åŒæ­¥ï¼š"
echo "  ./scripts/docker-trigger-sync.sh base-sepolia"
echo "  ./scripts/docker-trigger-sync.sh sepolia"
echo ""
echo "ç›‘æ§åŒæ­¥è¿›åº¦ï¼š"
echo "  docker compose logs -f backend | grep -E 'sync_started|agent_created'"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… é‡ç½®å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
